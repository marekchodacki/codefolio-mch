---
import { data as dataPL } from '../_data/pl/globals/navigation'
import { data as dataEN } from '../_data/en/globals/navigation'
import type { LayoutProps } from '../_data/types'

const { routeKey } = Astro.props as LayoutProps
const locale = Astro.currentLocale ?? 'pl'
const isEN = locale === 'en'
const data = isEN ? dataEN : dataPL
const { niv, nav } = data

function hrefFor(locale: string, localUrl: string) {
  if (localUrl === '/') return locale === 'pl' ? '/' : '/en/'
  return locale === 'pl' ? localUrl : `/en${localUrl}`
}

function switchHref(targetLocale: 'pl' | 'en', currentSlug: string) {
  const source = targetLocale === 'en' ? dataEN : dataPL
  const item = source.nav.find((i) => i.slug === currentSlug)
  const localUrl = item?.url ?? '/'
  return hrefFor(targetLocale, localUrl)
}

const langIcon = isEN ? '/assets/icons/nav_pl.svg' : '/assets/icons/nav_en.svg'
const langLabel = isEN ? 'Polski' : 'English'
const langHreflang = isEN ? 'pl' : 'en'
const switchUrl = switchHref(isEN ? 'pl' : 'en', routeKey)
---

<aside
  data-animation="default"
  data-collapse="medium"
  data-duration="400"
  data-easing="ease"
  data-easing2="ease"
  role="banner"
  class="sidebar w-nav"
>
  <div class="nav-content">
    <a href={hrefFor(locale, niv.url)} class="w-nav-brand" aria-label="home">
      <div class="niv-data">
        <img src={niv.image} loading="eager" alt={niv.alt} class="niv-image" />
        <div>
          <div class="label-white">{niv.name}</div>
          <div class="label-gray">{niv.vocation}</div>
        </div>
      </div>
    </a>

    <nav role="navigation" class="w-nav-menu">
      {
        nav.map((item) => (
          <a
            href={hrefFor(locale, item.url)}
            class={`nav-link-container w-inline-block ${
              routeKey === item.slug ? 'w--current' : ''
            }`}
          >
            <img
              src={item.icon}
              loading="eager"
              alt={item.alt}
              class="nav-link-image"
            />
            <div set:html={item.name} />
          </a>
        ))
      }

      <div
        class="nav-lang-switcher"
        role="group"
        aria-label="Language switcher"
      >
        {
          (
            <div
              class="nav-lang-switcher"
              role="group"
              aria-label="Language switcher"
            >
              <a
                href={switchUrl}
                hreflang={langHreflang}
                lang={langHreflang}
                aria-label={isEN ? 'Przełącz na polski' : 'Switch to English'}
                class="lang-link"
              >
                <img
                  src={langIcon}
                  alt={langLabel}
                  class="lang-flag"
                  width="20"
                  height="20"
                  loading="eager"
                />
                <span class="lang-code">{langLabel}</span>
              </a>
            </div>
          )
        }
      </div>
    </nav>

    <div
      class="navbar-icon-button w-nav-button"
      style="-webkit-user-select: text;"
      aria-label="menu"
      role="button"
      tabindex="0"
    >
      <img
        src="/assets/icons/btn_menu.svg"
        loading="eager"
        alt="Menu"
        class="navbar-icon"
      />
    </div>
  </div>

  <script>
    import { setupNav } from '../utils/nav.js'

    let cleanup
    document.addEventListener('astro:page-load', () => {
      if (cleanup) cleanup()
      cleanup = setupNav()
    })

    document.addEventListener('astro:before-swap', () => {
      if (cleanup) cleanup()
    })
  </script>
</aside>
